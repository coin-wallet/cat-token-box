import {
    AddressType,
    btc,
    callToBufferList,
    CHANGE_MIN_POSTAGE,
    getDummySigner,
    getDummyUTXO,
    getGuardsP2TR,
    getTokenContractP2TR,
    GuardContract,
    OpenMinterTokenInfo,
    Postage,
    SupportedNetwork,
    TokenContract,
    toP2tr,
    toStateScript,
    toTokenAddress,
    toTxOutpoint,
    verifyContract
} from "../common";
import {fill, int2ByteString, MethodCallOptions, PubKey, toByteString, UTXO,} from 'scrypt-ts';
import {EcKeyService,} from "../utils/eckey";
import {scaleConfig, tokenInfoParse} from "../utils/paramsUtils";
import {
    CAT20,
    CAT20Proto,
    CAT20State,
    ChangeInfo,
    emptyTokenAmountArray,
    emptyTokenArray,
    getBackTraceInfo,
    getTxCtxMulti,
    getTxHeaderCheck,
    GuardInfo,
    GuardProto,
    MAX_INPUT,
    MAX_TOKEN_OUTPUT,
    PreTxStatesInfo,
    ProtocolState,
    TokenUnlockArgs,
    TransferGuard
} from "@cat-protocol/cat-smartcontracts";
import Decimal from 'decimal.js';

export type CatTxParams = {
    privateKey: string;
    addressType: AddressType,
    data: any;
};

// transfer
export interface TransferParams {
    tokenMetadata: string
    feeUtxo: UTXO, // 暂时只支持一个feeUtxo输入
    feeRate: number,
    tokens: TokenContract[],
    changeAddress: string,
    receiver: string,
    tokenAmount: number,
    preTxMap: Map<string, string>,
    prePreTxMap: Map<string, string>,
}


export async function transfer(param: CatTxParams) {
    const ecKey = new EcKeyService(param.privateKey, param.addressType)

    const txParams: TransferParams = param.data

    let metadata = tokenInfoParse(txParams.tokenMetadata, SupportedNetwork.fractalMainnet);

    const minterP2TR = toP2tr(metadata.minterAddr);

    const {p2tr: tokenP2TR, tapScript: tokenTapScript} = getTokenContractP2TR(minterP2TR);

    // 地址和金额
    let receiver: btc.Address;
    let amount: bigint;
    try {
        receiver = btc.Address.fromString(txParams.receiver);
        if (receiver.type !== 'taproot') {
            console.error(`Invalid address type: ${receiver.type}`);
            return;
        }
    } catch (error) {
        console.error(`Invalid receiver address:  `, txParams.receiver);
        return;
    }

    const scaledInfo = scaleConfig(metadata.info as OpenMinterTokenInfo);
    try {
        const d = new Decimal(txParams.tokenAmount).mul(Math.pow(10, scaledInfo.decimals));
        amount = BigInt(d.toString());
    } catch (error) {
        console.error(`Invalid receiver address:  `, txParams.tokenAmount);
        return;
    }


    let tokens = txParams.tokens;
    const commitResult = createGuardContract(
        ecKey,
        txParams.feeUtxo,
        txParams.feeRate,
        tokens,
        tokenP2TR,
        txParams.changeAddress,
    );


    if (commitResult === null) {
        return null;
    }
    const {commitTx, contact: guardContract, guardTapScript} = commitResult;

    const newState = ProtocolState.getEmptyState();

    const receiverTokenState = CAT20Proto.create(
        amount,
        toTokenAddress(receiver),
    );

    newState.updateDataList(0, CAT20Proto.toByteString(receiverTokenState));

    const tokenInputAmount = tokens.reduce(
        (acc, t) => acc + t.state.data.amount,
        0n,
    );

    const changeTokenInputAmount = tokenInputAmount - amount;

    let changeTokenState: null | CAT20State = null;

    if (changeTokenInputAmount > 0n) {
        const tokenChangeAddress = ecKey.getTokenAddress();
        changeTokenState = CAT20Proto.create(
            changeTokenInputAmount,
            tokenChangeAddress,
        );
        newState.updateDataList(1, CAT20Proto.toByteString(changeTokenState));
    }

    const newFeeUtxo = {
        txId: commitTx.id,
        outputIndex: 2,
        script: commitTx.outputs[2].script.toHex(),
        satoshis: commitTx.outputs[2].satoshis,
    };

    const inputUtxos = [
        ...tokens.map((t) => t.utxo),
        guardContract.utxo,
        newFeeUtxo,
    ];

    if (inputUtxos.length > MAX_INPUT) {
        throw new Error('to much input');
    }

    const revealTx = new btc.Transaction()
        .from(inputUtxos)
        .addOutput(
            new btc.Transaction.Output({
                satoshis: 0,
                script: toStateScript(newState),
            }),
        )
        .addOutput(
            new btc.Transaction.Output({
                satoshis: Postage.TOKEN_POSTAGE,
                script: tokenP2TR,
            }),
        )
        .feePerByte(txParams.feeRate);

    if (changeTokenState) {
        revealTx.addOutput(
            new btc.Transaction.Output({
                satoshis: Postage.TOKEN_POSTAGE,
                script: tokenP2TR,
            }),
        );
    }

    const satoshiChangeScript = btc.Script.fromAddress(txParams.changeAddress);
    revealTx.addOutput(
        new btc.Transaction.Output({
            satoshis: 0,
            script: satoshiChangeScript,
        }),
    );

    let prevTokenInputIndex = 2
    let prevTxHex = '02000000000102a87eaf4a5b1ebf008c1cfdafa570c057909a5068c92429a26e4c0ce84b96c8960200000000ffffffff9a746f295e2f23124dd9b6c8e405df680eb3efdfb593fb2932d99b55844711530200000000ffffffff0500000000000000001a6a1863617401850759062665ac381528ad7e0bf09b0332fdeb404b010000000000002251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f4b010000000000002251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f4a01000000000000225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed00383ad1000000000225120991aa7dd18daf34865086c8a7c134ac83bee0fc9217ec346d138247a2d6e6982681482fe99bdc279e395167143d68168258688098fcc147d345c05948faa2a06fb254c39bae38f53fc36dc1444876a0c881ea808e71b0ba8ef75b82dc1f64a9c000014c356c0b7212408fa4a4d8a7ee59e48f729cb1b1f02e80303389d0703801a060020991aa7dd18daf34865086c8a7c134ac83bee0fc9217ec346d138247a2d6e69824020dc846d86a4233acae560ddb9aced8cecf2bff884f5d287fc8ba56c54becaf61dbb72762a6a97da9eff6646747cf5cc01a0f6f1da4988d66a052f82ee091ef0084b01000000000000084a01000000000000225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed0010103a0bb0d149cc27a2b16b040bed245a11301afb60a533e6c84143c29269693a2b6ba67e835e9613cc691e1c78a44149d7b097862dc21b28be1e870c7f9776135c6aeba145a0485085018dbce13f60944cdf454f799a4150e0000040200000001022967a498d85583173fe72c50d7e70e5b0fc479aff01cc5ae8c3eb80054a068a21d0100000000ffffffff291eed3674ad6fd388be17717d0fce3f28227ad7ffc1d43b44dc601b13e501e7590400000000ffffffff0000000001050105080000000000000000084b01000000000000084b01000000000000084a0100000000000008e458460200000000001a6a18636174019cc27a2b16b040bed245a11301afb60a533e6c842251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f2251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed0225120b2cc03e567a1a217367e54beb419cc4df10e26bff703891e1764254edbdbc9210004010000002067a498d85583173fe72c50d7e70e5b0fc479aff01cc5ae8c3eb80054a068a21d0401000000010104ffffffff005002000000027f4e613acee9c3303d3e3ff46d6086e71dcb0ee8e15272446de2a74f269920090100000000ffffffff82ded1081392ce8e5b76b21b5ba5d455558e29b3c1508ed9cf77475424cb584b040008000000ffffffff05000001050105080000000000000000084b01000000000000084b01000000000000084a01000000000000085aedcc3200000000001a6a18636174018679a381349b376969dc36b56965ab871f6b8dd42251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f2251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed022512048376eca558e41f081c2350c573c86b00a5f6aacaf24bfbf774555b8b53114be00040100000004020000000400000000203dd6f005551a7949c0ec40c91bf3267d5c09f172198cb7b3f13c4de9a55adc5620edf07163ba73faad537cd1863d8ff5f2e796d6ddaa24db51189aaca9906210082050574cfe9a8da211883d09090a791d21b707383471f5d4b761bed1ad055e0cd62012a3ae445661ce5dee78d0650d33362dec29c4f82af05e7e57fb595bbbacf0ca20b9510c9bd1c6ad33397add19eeda49dd3c1450eef2c1f4bfdc6cd37e95209cc201020400000000204a0777e9e20d5184df77ec9ef6e0a2782af463faeab39c5e43a9118babdf5a8d010004ffffffff1f3dd352b8284acce051c6d1fa555956aac5ae57ec3bd54a52d26e6bf36cb941013e24a87eaf4a5b1ebf008c1cfdafa570c057909a5068c92429a26e4c0ce84b96c89602000000249a746f295e2f23124dd9b6c8e405df680eb3efdfb593fb2932d99b5584471153020000000000000000010220a87eaf4a5b1ebf008c1cfdafa570c057909a5068c92429a26e4c0ce84b96c89604020000002251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f225120991aa7dd18daf34865086c8a7c134ac83bee0fc9217ec346d138247a2d6e698200000000225120991aa7dd18daf34865086c8a7c134ac83bee0fc9217ec346d138247a2d6e6982080383ad1000000000fd7e0d0800000000000000002079be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f817984c807bb52d7a9fef58323eb1bf7a407db382d2f3f2d81bb1224f49fe518f6d48d37c7bb52d7a9fef58323eb1bf7a407db382d2f3f2d81bb1224f49fe518f6d48d37c79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179879be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179842f40a48df4b2a70c8b4924bf2654661ed3d95fd66a313eb87237597c628e4a031f40a48df4b2a70c8b4924bf2654661ed3d95fd66a313eb87237597c628e4a0310000243ccc995149727a3e74b69aec896a39e168112b841cb5fa477e4aec7fe83010f3000000000400752b7d0003a08601000128790128790128790128790128790128790128790128790128790128790128790128790128790128790113795e797e5d797e5c797e5b797e5a797e59797e58797e57797e56797e55797e54797e53797ea8011579787ea85279017f9f695279009c6301006752796878557952797e8801187955797e54798b7e6b6d6d6d6d6d6d6d6d6c775879ad011a79011a79011a79011a79011a79011a79011a79011a79011a79011a79013079012b795b795b795b795b795b795b790056766b796c756e7e777755766b796c756e7e777754766b796c756e7e777753766b796c756e7e777752766b796c756e7e777751766b796c756e7e7b756b6d6d6d6c77a852798855796e760087630100776876030000007e527987777777695479537978760087630100776876030000007e527987777777695b795b795b795b795b795b79565c797600a26976569f69948c766b796c756b6d6d6d6c547954797e886d6d6d6d6d6d607960796079607960796079012a795679567956795679567956790056766b796c756e827752797e7e777755766b796c756e827752797e7e777754766b796c756e827752797e7e777753766b796c756e827752797e7e777752766b796c756e827752797e7e777751766b796c756e827752797e7e7b756b6d6d6d6c77a878886d6d6d75015d79015d79015d79015d79015d79015d79016679016679016679786351670100685379787e52797ea96b6d6d6c014e79014e79014e79014e79014e79014e7956007600a26976569f69948c766b796c756b6d6d6d6c011b795879066a1863617401787e77527988577957795779577957795d79007657766b796c75a97e7d7756766b796c75a97e7d7755766b796c75a97e7d7754766b796c75a97e7d7753766b796c75a97e7d77a95279876b6d6d6d6c77695279587958795879587958795557798c7600a26976559f69948c766b796c756b6d6d756c886d6d6d6d75600115797600a26976569f6994766b796c750113790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790135790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790116790116797e7601167901167901167901167901167901167955766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167954766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167953766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167952766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167951766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167900766b796c756b6d6d6d6c7e7d775f797e775f795f79885d795d795d795d795d795d7955766b796c756b6d6d6d6c58795879587958795879587955766b796c756b6d6d6d6c768277000113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7954766b796c756b6d6d6d6c58795879587958795879587954766b796c756b6d6d6d6c768277510113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7953766b796c756b6d6d6d6c58795879587958795879587953766b796c756b6d6d6d6c768277520113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7952766b796c756b6d6d6d6c58795879587958795879587952766b796c756b6d6d6d6c768277530113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7951766b796c756b6d6d6d6c58795879587958795879587951766b796c756b6d6d6d6c768277540113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7900766b796c756b6d6d6d6c58795879587958795879587900766b796c756b6d6d6d6c768277550113799f637052797e53797e7e547a7572537a537975686d787752797eaa6b6d6d6d6d6d6d6d6d6d6d6d6d6c88011979011979011979011979707e01007e787e6b6d6d6c012f79012f79012f79012f79012f79012f7956011d797600a26976569f69948c766b796c756b6d6d6d6c8801177901197978760087630100776876030000007e527987777777690119790119797e7653798764011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579012d79012c79011679011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579007601147901147901147901147953766b796c756b6d6d6c7e7d7701147901147901147901147952766b796c756b6d6d6c7e7d7701147901147901147901147951766b796c756b6d6d6c7e7d7701147901147901147901147900766b796c756b6d6d6c7e775f795f79885d795d795d795d795d795d7955766b796c756b6d6d6d6c58795879587958795879587955766b796c756b6d6d6d6c768277000113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7954766b796c756b6d6d6d6c58795879587958795879587954766b796c756b6d6d6d6c768277510113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7953766b796c756b6d6d6d6c58795879587958795879587953766b796c756b6d6d6d6c768277520113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7952766b796c756b6d6d6d6c58795879587958795879587952766b796c756b6d6d6d6c768277530113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7951766b796c756b6d6d6d6c58795879587958795879587951766b796c756b6d6d6d6c768277540113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7900766b796c756b6d6d6d6c58795879587958795879587900766b796c756b6d6d6d6c768277550113799f637052797e53797e7e547a7572537a537975686d787752797eaa6b6d6d6d6d6d6d6d6d6d6d6c5379885979597959795979597959795658797600a26976569f69948c766b796c756b6d6d6d6c78886d6d6d6d6d6d6d6d6d6d6d686d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d7500000000016c766b796c787700a0636e937b757c52798b537a757b7b52797554795679016a7978827d770122a1696e7e53797e7777777e557a75547a547a547a547a5479755379016779515379786351670100685379787e52797ea96b6d6d6ca97e547a7572537a5379756875016c8c766b796c787700a0636e937b757c52798b537a757b7b52797554795679016a7978827d770122a1696e7e53797e7777777e557a75547a547a547a547a5479755379016779515379786351670100685379787e52797ea96b6d6d6ca97e547a7572537a537975687500016e7900a06378016f79937b757c52798b537a757b7b527975537901707901707978827701149d6e7ea97777a97e547a7572537a53797501667901687978827d770122a1696e7e53797e6b6d6d6c6801657964587900a067006863016b79016b797ea9577988016979016b79ad780165795a79939d59790165795a79939d016e7959799d67780165799d016e795879a169687001767901767901767901767901767956795679557894000052799f637600a97e77685152799f637600a97e77685252799f637600a97e77685352799f637600a97e77685452799f637600a97e776877777ea9557955795579557955795579007657766b796c75a97e7d7756766b796c75a97e7d7755766b796c75a97e7d7754766b796c75a97e7d7753766b796c75a97e7d77a95279876b6d6d6d6c776976066a1863617401787e770800000000000000007882777e787e6b6d6d6d6d6c770111790111797601127987646e78827d770122a1696e7e53797e77777767006877777857797e53797e787ea876012c79876b6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6c21c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac001414203e32c339330038aeaa50cb3e17ad4d874edf4a1341a4f644a753adccd745675a011b66c913eeb6a638f2a807342011a6884ee9f5fdc9404e00a1954ddf63c0100000000'
    let prevTx = new btc.Transaction(prevTxHex);

    let prevPrevTxHex = '0200000000010267a498d85583173fe72c50d7e70e5b0fc479aff01cc5ae8c3eb80054a068a21d0100000000ffffffff1eed3674ad6fd388be17717d0fce3f28227ad7ffc1d43b44dc601b13e501e7590400000000ffffffff0500000000000000001a6a18636174019cc27a2b16b040bed245a11301afb60a533e6c844b010000000000002251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f4b010000000000002251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f4a01000000000000225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed0e458460200000000225120b2cc03e567a1a217367e54beb419cc4df10e26bff703891e1764254edbdbc92168143c29269693a2b6ba67e835e9613cc691e1c78a44149d7b097862dc21b28be1e870c7f9776135c6aeba145a0485085018dbce13f60944cdf454f799a4150e000014191c161b7289cdfacabdee133b602f9fc445240a03a086010340420f03a0bb0d0020b2cc03e567a1a217367e54beb419cc4df10e26bff703891e1764254edbdbc921401912976ae17618bf1cb6d8eacb6fe2b67b828fe4a034923770e67aa4cb37d1e91b7debce9e12a60f041dabfdad0e1b133fef7fa3a527115c73b46b14ad958fb3084b01000000000000084a01000000000000225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed001010380841e148679a381349b376969dc36b56965ab871f6b8dd414849a6f782ebb14d7609467f7c40ac9bd3956dcc61407784a0228b0defb50143deae0df0fc2e36450e614e0aba94b26f55614055ca3bbefa9bf1521ec36e9000004020000000102297f4e613acee9c3303d3e3ff46d6086e71dcb0ee8e15272446de2a74f269920090100000000ffffffff2982ded1081392ce8e5b76b21b5ba5d455558e29b3c1508ed9cf77475424cb584b0400000000ffffffff0000000001050105080000000000000000084b01000000000000084b01000000000000084a01000000000000085aedcc3200000000001a6a18636174018679a381349b376969dc36b56965ab871f6b8dd42251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f2251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed022512048376eca558e41f081c2350c573c86b00a5f6aacaf24bfbf774555b8b53114be000401000000207f4e613acee9c3303d3e3ff46d6086e71dcb0ee8e15272446de2a74f269920090401000000010104ffffffff005002000000023c98e71b0017790b64c3e3a6a30ab0a68ab8275de21a4a71a1c857390a6bc6030200000000ffffffff644584d39a599c996b2f58865939c256ebfc2a0db5800f38849e2599e6787c23040008000000ffffffff05000001050105080000000000000000084b01000000000000084b01000000000000084a01000000000000089db3850100000000001a6a186361740155e9c4c97a495ff4ba96e54dbb0d2db61919bee02251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f2251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f225120a596af59a76c7494130948429535f7bf58045753ecd9bb2a8707da8009038ed0225120a62676c347a230f7daba6d9bc3d8652a77ee131c1ea96c4846a98641a82033600004020000000402000000040100000020db03b2abeacadf6dcff3be1f363af000b0af1cc82adc0825577c1cf565e65a57209d47d01e99daee67c5353610dedc2635848967c338559dfdf99ad5ce8cb79a8920cc388260b1955d16a9b91d5e389c2e06d8bc32cb050238572144825e0dec35302012a3ae445661ce5dee78d0650d33362dec29c4f82af05e7e57fb595bbbacf0ca20a2b31f1abc1af7ac28bbf8d1f7b869bafe4dddd471ad97bb42087e2199c8632301020400000000204a0777e9e20d5184df77ec9ef6e0a2782af463faeab39c5e43a9118babdf5a8d010004ffffffff1fda7bbdd92342d609fd768a631535d7ae997a59e3c462c164c25a709aaeeef9017e2467a498d85583173fe72c50d7e70e5b0fc479aff01cc5ae8c3eb80054a068a21d01000000241eed3674ad6fd388be17717d0fce3f28227ad7ffc1d43b44dc601b13e501e75904000000000000000001012067a498d85583173fe72c50d7e70e5b0fc479aff01cc5ae8c3eb80054a068a21d04010000002251206c1a0fda20c43cf6f2dbdcb193fcb7cc967d69939e7aad9554f194bf5b00ed3f225120b2cc03e567a1a217367e54beb419cc4df10e26bff703891e1764254edbdbc92100000000225120b2cc03e567a1a217367e54beb419cc4df10e26bff703891e1764254edbdbc92108e458460200000000fd7e0d0800000000000000002079be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f817984c807bb52d7a9fef58323eb1bf7a407db382d2f3f2d81bb1224f49fe518f6d48d37c7bb52d7a9fef58323eb1bf7a407db382d2f3f2d81bb1224f49fe518f6d48d37c79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179879be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179842f40a48df4b2a70c8b4924bf2654661ed3d95fd66a313eb87237597c628e4a031f40a48df4b2a70c8b4924bf2654661ed3d95fd66a313eb87237597c628e4a0310000243ccc995149727a3e74b69aec896a39e168112b841cb5fa477e4aec7fe83010f3000000000400752b7d0003a08601000128790128790128790128790128790128790128790128790128790128790128790128790128790128790113795e797e5d797e5c797e5b797e5a797e59797e58797e57797e56797e55797e54797e53797ea8011579787ea85279017f9f695279009c6301006752796878557952797e8801187955797e54798b7e6b6d6d6d6d6d6d6d6d6c775879ad011a79011a79011a79011a79011a79011a79011a79011a79011a79011a79013079012b795b795b795b795b795b795b790056766b796c756e7e777755766b796c756e7e777754766b796c756e7e777753766b796c756e7e777752766b796c756e7e777751766b796c756e7e7b756b6d6d6d6c77a852798855796e760087630100776876030000007e527987777777695479537978760087630100776876030000007e527987777777695b795b795b795b795b795b79565c797600a26976569f69948c766b796c756b6d6d6d6c547954797e886d6d6d6d6d6d607960796079607960796079012a795679567956795679567956790056766b796c756e827752797e7e777755766b796c756e827752797e7e777754766b796c756e827752797e7e777753766b796c756e827752797e7e777752766b796c756e827752797e7e777751766b796c756e827752797e7e7b756b6d6d6d6c77a878886d6d6d75015d79015d79015d79015d79015d79015d79016679016679016679786351670100685379787e52797ea96b6d6d6c014e79014e79014e79014e79014e79014e7956007600a26976569f69948c766b796c756b6d6d6d6c011b795879066a1863617401787e77527988577957795779577957795d79007657766b796c75a97e7d7756766b796c75a97e7d7755766b796c75a97e7d7754766b796c75a97e7d7753766b796c75a97e7d77a95279876b6d6d6d6c77695279587958795879587958795557798c7600a26976559f69948c766b796c756b6d6d756c886d6d6d6d75600115797600a26976569f6994766b796c750113790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790159790135790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790131790116790116797e7601167901167901167901167901167901167955766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167954766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167953766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167952766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167951766b796c756b6d6d6d6c7e7d7701167901167901167901167901167901167900766b796c756b6d6d6d6c7e7d775f797e775f795f79885d795d795d795d795d795d7955766b796c756b6d6d6d6c58795879587958795879587955766b796c756b6d6d6d6c768277000113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7954766b796c756b6d6d6d6c58795879587958795879587954766b796c756b6d6d6d6c768277510113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7953766b796c756b6d6d6d6c58795879587958795879587953766b796c756b6d6d6d6c768277520113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7952766b796c756b6d6d6d6c58795879587958795879587952766b796c756b6d6d6d6c768277530113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7951766b796c756b6d6d6d6c58795879587958795879587951766b796c756b6d6d6d6c768277540113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7900766b796c756b6d6d6d6c58795879587958795879587900766b796c756b6d6d6d6c768277550113799f637052797e53797e7e547a7572537a537975686d787752797eaa6b6d6d6d6d6d6d6d6d6d6d6d6d6c88011979011979011979011979707e01007e787e6b6d6d6c012f79012f79012f79012f79012f79012f7956011d797600a26976569f69948c766b796c756b6d6d6d6c8801177901197978760087630100776876030000007e527987777777690119790119797e7653798764011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579012d79012c79011679011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579011579007601147901147901147901147953766b796c756b6d6d6c7e7d7701147901147901147901147952766b796c756b6d6d6c7e7d7701147901147901147901147951766b796c756b6d6d6c7e7d7701147901147901147901147900766b796c756b6d6d6c7e775f795f79885d795d795d795d795d795d7955766b796c756b6d6d6d6c58795879587958795879587955766b796c756b6d6d6d6c768277000113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7954766b796c756b6d6d6d6c58795879587958795879587954766b796c756b6d6d6d6c768277510113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7953766b796c756b6d6d6d6c58795879587958795879587953766b796c756b6d6d6d6c768277520113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7952766b796c756b6d6d6d6c58795879587958795879587952766b796c756b6d6d6d6c768277530113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7951766b796c756b6d6d6d6c58795879587958795879587951766b796c756b6d6d6d6c768277540113799f637052797e53797e7e547a7572537a537975686d755d795d795d795d795d795d7900766b796c756b6d6d6d6c58795879587958795879587900766b796c756b6d6d6d6c768277550113799f637052797e53797e7e547a7572537a537975686d787752797eaa6b6d6d6d6d6d6d6d6d6d6d6c5379885979597959795979597959795658797600a26976569f69948c766b796c756b6d6d6d6c78886d6d6d6d6d6d6d6d6d6d6d686d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d7500000000016c766b796c787700a0636e937b757c52798b537a757b7b52797554795679016a7978827d770122a1696e7e53797e7777777e557a75547a547a547a547a5479755379016779515379786351670100685379787e52797ea96b6d6d6ca97e547a7572537a5379756875016c8c766b796c787700a0636e937b757c52798b537a757b7b52797554795679016a7978827d770122a1696e7e53797e7777777e557a75547a547a547a547a5479755379016779515379786351670100685379787e52797ea96b6d6d6ca97e547a7572537a537975687500016e7900a06378016f79937b757c52798b537a757b7b527975537901707901707978827701149d6e7ea97777a97e547a7572537a53797501667901687978827d770122a1696e7e53797e6b6d6d6c6801657964587900a067006863016b79016b797ea9577988016979016b79ad780165795a79939d59790165795a79939d016e7959799d67780165799d016e795879a169687001767901767901767901767901767956795679557894000052799f637600a97e77685152799f637600a97e77685252799f637600a97e77685352799f637600a97e77685452799f637600a97e776877777ea9557955795579557955795579007657766b796c75a97e7d7756766b796c75a97e7d7755766b796c75a97e7d7754766b796c75a97e7d7753766b796c75a97e7d77a95279876b6d6d6d6c776976066a1863617401787e770800000000000000007882777e787e6b6d6d6d6d6c770111790111797601127987646e78827d770122a1696e7e53797e77777767006877777857797e53797e787ea876012c79876b6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6c21c150929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac00141b93085698af59cc2af3ae65c3c8ef75f194f327aaac1930c6a47974996ddde6f8acf85baa1c9a7f506b841a56903e7dd5383486a4e84432705c15836b96f0d540101000000';
    let prevPrevTx = new btc.Transaction(prevPrevTxHex);

    const guardCommitTxHeader = getTxHeaderCheck(
        commitTx,
        guardContract.utxo.outputIndex,
    );

    const guardInputIndex = tokens.length;
    const guardInfo: GuardInfo = {
        outputIndex: toTxOutpoint(
            guardContract.utxo.txId,
            guardContract.utxo.outputIndex,
        ).outputIndex,
        inputIndexVal: BigInt(guardInputIndex),
        tx: guardCommitTxHeader.tx,
        guardState: guardContract.state.data,
    };

    let vsize = 500

    const satoshiChangeAmount =
        revealTx.inputAmount -
        vsize * txParams.feeRate -
        Postage.TOKEN_POSTAGE -
        (changeTokenState === null ? 0 : Postage.TOKEN_POSTAGE);

    if (satoshiChangeAmount <= CHANGE_MIN_POSTAGE) {
        console.error('Insufficient satoshis balance!');
        return null;
    }

    const satoshiChangeOutputIndex = changeTokenState === null ? 2 : 3;

    // update change amount
    revealTx.outputs[satoshiChangeOutputIndex].satoshis = satoshiChangeAmount;


    const txCtxs = getTxCtxMulti(
        revealTx,
        tokens.map((_, i) => i).concat([tokens.length]),
        [
            ...new Array(tokens.length).fill(Buffer.from(tokenTapScript, 'hex')),
            Buffer.from(guardTapScript, 'hex'),
        ],
    );

    const changeInfo: ChangeInfo = {
        script: toByteString(satoshiChangeScript.toHex()),
        satoshis: int2ByteString(BigInt(satoshiChangeAmount), 8n),
    };

    for (let i = 0; i < tokens.length; i++) {
        // ignore changeInfo when transfer token
        const res = await unlockToken(
            ecKey,
            tokens[i],
            i,
            prevTx,
            prevTokenInputIndex,
            prevPrevTx,
            guardInfo,
            revealTx,
            minterP2TR,
            txCtxs[i],
            false,
        );

        if (!res) {
            return null;
        }
    }
    const res = await unlockGuard(
        guardContract,
        guardInfo,
        guardInputIndex,
        newState,
        revealTx,
        receiverTokenState,
        changeTokenState,
        changeInfo,
        txCtxs[guardInputIndex],
        false,
    );

    if (!res) {
        return null;
    }

    ecKey.signTx(revealTx);

    console.log("revealTx==>", revealTx.uncheckedSerialize())
    console.log("commitTx==>", commitTx.uncheckedSerialize())

    return {
        revealTx,
        commitTx,
    }

}


export function createGuardContract(
    wallet: EcKeyService,
    feeutxo: UTXO,
    feeRate: number,
    tokens: TokenContract[],
    tokenP2TR: string,
    changeAddress: btc.Address,
) {
    const {p2tr: guardP2TR, tapScript: guardTapScript} = getGuardsP2TR();

    const protocolState = ProtocolState.getEmptyState();
    const realState = GuardProto.createEmptyState();
    realState.tokenScript = tokenP2TR;

    for (let i = 0; i < tokens.length; i++) {
        realState.inputTokenAmountArray[i] = tokens[i].state.data.amount;
    }

    protocolState.updateDataList(0, GuardProto.toByteString(realState));

    const commitTx = new btc.Transaction()
        .from(feeutxo)
        .addOutput(
            new btc.Transaction.Output({
                satoshis: 0,
                script: toStateScript(protocolState),
            }),
        )
        .addOutput(
            new btc.Transaction.Output({
                satoshis: Postage.GUARD_POSTAGE,
                script: guardP2TR,
            }),
        )
        .feePerByte(feeRate)
        .change(changeAddress);

    if (commitTx.getChangeOutput() === null) {
        console.error('Insufficient satoshis balance!');
        return null;
    }
    commitTx.outputs[2].satoshis -= 1;
    wallet.signTx(commitTx);

    const contact: GuardContract = {
        utxo: {
            txId: commitTx.id,
            outputIndex: 1,
            script: commitTx.outputs[1].script.toHex(),
            satoshis: commitTx.outputs[1].satoshis,
        },
        state: {
            protocolState,
            data: realState,
        },
    };

    return {
        commitTx,
        contact,
        guardTapScript,
    };
}


async function unlockToken(
    wallet: EcKeyService,
    tokenContract: TokenContract,
    tokenInputIndex: number,
    prevTokenTx: btc.Transaction,
    preTokenInputIndex: number,
    prevPrevTokenTx: btc.Transaction,
    guardInfo: GuardInfo,
    revealTx: btc.Transaction,
    minterP2TR: string,
    txCtx: any,
    verify: boolean,
) {
    const {cblock: cblockToken, contract: token} = getTokenContractP2TR(minterP2TR);

    const {shPreimage, prevoutsCtx, spentScripts, sighash} = txCtx;

    const sig = btc.crypto.Schnorr.sign(
        wallet.getTokenPrivateKey(),
        sighash.hash,
    );
    const pubkeyX = wallet.getXOnlyPublicKey();
    const pubKeyPrefix = wallet.getPubKeyPrefix();
    const tokenUnlockArgs: TokenUnlockArgs = {
        isUserSpend: true,
        userPubKeyPrefix: pubKeyPrefix,
        userPubKey: PubKey(pubkeyX),
        userSig: sig.toString('hex'),
        contractInputIndex: 0n,
    };

    const backtraceInfo = getBackTraceInfo(
        prevTokenTx,
        prevPrevTokenTx,
        preTokenInputIndex,
    );

    const {
        state: {protocolState, data: preState},
    } = tokenContract;

    await token.connect(getDummySigner());
    const preTxState: PreTxStatesInfo = {
        statesHashRoot: protocolState.hashRoot,
        txoStateHashes: protocolState.stateHashList,
    };

    const tokenCall = await token.methods.unlock(
        tokenUnlockArgs,
        preState,
        preTxState,
        guardInfo,
        backtraceInfo,
        shPreimage,
        prevoutsCtx,
        spentScripts,
        {
            fromUTXO: getDummyUTXO(),
            verify: false,
            exec: false,
        } as MethodCallOptions<CAT20>,
    );

    const witnesses = [
        ...callToBufferList(tokenCall),
        // taproot script + cblock
        token.lockingScript.toBuffer(),
        Buffer.from(cblockToken, 'hex'),
    ];
    revealTx.inputs[tokenInputIndex].witnesses = witnesses;

    if (verify) {
        const res = verifyContract(
            tokenContract.utxo,
            revealTx,
            tokenInputIndex,
            witnesses,
        );
        if (typeof res === 'string') {
            console.error('unlocking token contract failed!', res);
            return false;
        }
        return true;
    }

    return true;
}


async function unlockGuard(
    guardContract: GuardContract,
    guardInfo: GuardInfo,
    guardInputIndex: number,
    newState: ProtocolState,
    revealTx: btc.Transaction,
    receiverTokenState: CAT20State,
    changeTokenState: null | CAT20State,
    changeInfo: ChangeInfo,
    txCtx: any,
    verify: boolean,
) {
    // amount check run verify

    const {shPreimage, prevoutsCtx, spentScripts} = txCtx;
    const outputArray = emptyTokenArray();
    const tokenAmountArray = emptyTokenAmountArray();
    const tokenOutputIndexArray = fill(false, MAX_TOKEN_OUTPUT);
    outputArray[0] = receiverTokenState.ownerAddr;
    tokenAmountArray[0] = receiverTokenState.amount;
    tokenOutputIndexArray[0] = true;

    if (changeTokenState) {
        outputArray[1] = changeTokenState.ownerAddr;
        tokenAmountArray[1] = changeTokenState.amount;
        tokenOutputIndexArray[1] = true;
    }

    const satoshiChangeOutputIndex = changeTokenState === null ? 1 : 2;

    const {cblock: transferCblock, contract: transferGuard} = getGuardsP2TR();

    await transferGuard.connect(getDummySigner());

    const outpointSatoshiArray = emptyTokenArray();
    outpointSatoshiArray[satoshiChangeOutputIndex] = changeInfo.satoshis;
    outputArray[satoshiChangeOutputIndex] = changeInfo.script;
    tokenOutputIndexArray[satoshiChangeOutputIndex] = false;

    const transferGuardCall = await transferGuard.methods.transfer(
        newState.stateHashList,
        outputArray,
        tokenAmountArray,
        tokenOutputIndexArray,
        outpointSatoshiArray,
        int2ByteString(BigInt(Postage.TOKEN_POSTAGE), 8n),
        guardContract.state.data,
        guardInfo.tx,
        shPreimage,
        prevoutsCtx,
        spentScripts,
        {
            fromUTXO: getDummyUTXO(),
            verify: false,
            exec: false,
        } as MethodCallOptions<TransferGuard>,
    );
    const witnesses = [
        ...callToBufferList(transferGuardCall),
        // taproot script + cblock
        transferGuard.lockingScript.toBuffer(),
        Buffer.from(transferCblock, 'hex'),
    ];
    revealTx.inputs[guardInputIndex].witnesses = witnesses;

    if (verify) {
        const res = verifyContract(
            guardContract.utxo,
            revealTx,
            guardInputIndex,
            witnesses,
        );
        if (typeof res === 'string') {
            console.error('unlocking guard contract failed!', res);
            return false;
        }
        return true;
    }
    return true;
}
